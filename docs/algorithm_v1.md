# ИТОГОВЫЙ АЛГОРИТМ ГЕНЕРАЦИИ ПЕРСОНАЛИЗИРОВАННОГО УЧЕБНОГО КУРСА

## Архитектура системы

Система состоит из **3 фаз**, **8 блоков** и **~35 шагов**.

```
ФАЗА A: СБОР ДАННЫХ (Блоки 1-5) ─── Диалог с пользователем
    │
ФАЗА B: ПРОЕКТИРОВАНИЕ (Блоки 6-7) ─── Генерация курса системой
    │
ФАЗА C: ОБУЧЕНИЕ (Блок 8) ─── Проблемно-ориентированное проведение занятий
```

---

## ФАЗА A: СБОР ДАННЫХ И ПРОФИЛИРОВАНИЕ

> Цель: получить от пользователя структурированные ответы для построения профиля.
> Формат: пошаговый диалог — система задаёт вопросы, пользователь отвечает.
> Алгоритм: './phase_a.md'
---

## ФАЗА B: ПРОЕКТИРОВАНИЕ ПЕРСОНАЛИЗИРОВАННОГО УЧЕБНОГО ТРЕКА

> Цель: На основе `StudentProfile` (выход фазы A) спроектировать полный персонализированный учебный трек: от компетенций до понедельного расписания с учебными единицами.
> Формат: генерация учебного трека в автоматическом режиме
> Алгоритм: './phase_b.md'
---

---

## ФАЗА C: ПРОВЕДЕНИЕ ОБУЧЕНИЯ (ПРОБЛЕМНО-ОРИЕНТИРОВАННЫЙ ПОДХОД)

> Цель: провести студента через каждую тему трека с использованием проблемно-ориентированных учебных действий.
> Формат: интерактивный диалог «система <-> студент» по каждой теме.

---

### БЛОК 8. Движок проведения занятий (конечный автомат)

> Этот блок реализует цикл обучения для каждой учебной единицы из трека.
> Система работает как конечный автомат (Finite State Machine) с 8 состояниями.

---

#### Шаг 8.0 — Инициализация занятия

| Параметр | Значение |
|---|---|
| **Название** | `init_lesson` |
| **Что делает система** | Загружает текущую учебную единицу из трека, определяет начальное состояние. |
| **Вход** | Текущая `LearningUnit` из `Track.weeks[i].sessions[j]` |
| **Выход** | `lesson_state`: {current_state: "PP", unit: LearningUnit, attempt_count: 0, hints_used: 0, history: []} |
| **Следующий шаг** | Всегда -> Шаг 8.1 (ПП) |

---

#### Шаг 8.1 — Практическая проблема (ПП)

| Параметр | Значение |
|---|---|
| **Название** | `present_problem` |
| **Код состояния** | `PP` |
| **Что делает система** | Формулирует проблему на основе текущей учебной единицы. Проблема может быть в форме: проблемной постановки («не хватает...»), проблемного вопроса («что нужно для...?»), конкретной аутентичной задачи («найди..., реши...»), кейса (описание реальной ситуации). Формат выбирается исходя из `unit.type` и `profile.theory_format_preference`. |
| **Сообщение пользователю** | Контекстная задача, привязанная к реальности студента. Пример: «Представьте, друг говорит: "Если я получу премию, то куплю тебе кофе". В каких ситуациях он сдержит слово, а в каких — солжёт?» |
| **Ожидаемые типы ответа** | см. таблицу переходов ниже |

**Таблица переходов из ПП:**

| Ответ ученика | Следующее состояние | Логика |
|---|---|---|
| Выдвигает >=1 гипотезу (даже неверную) | -> ГП (8.2) | Фиксируем гипотезы |
| Молчит / "не знаю" | -> ПЗ (8.8) -> возврат к ПП или ГП | Стимулирующая подсказка |
| Задаёт уточняющие вопросы | -> КИ (8.3) | Точечная теория |
| Сразу предлагает решение | -> ПТ (8.5) | Усложняем противоречием |

---

#### Шаг 8.2 — Гипотезы (ГП)

| Параметр | Значение |
|---|---|
| **Название** | `collect_hypotheses` |
| **Код состояния** | `GP` |
| **Что делает система** | Анализирует гипотезы ученика: оценивает текущий уровень понимания, выявляет пробелы и фокусы. |
| **Сообщение пользователю** | «Интересно! Расскажите подробнее, как вы к этому пришли?» (или аналогичное поощрение к развёртыванию гипотез) |

**Таблица переходов из ГП:**

| Ответ ученика | Следующее состояние | Логика |
|---|---|---|
| Есть явный пробел (незнание ключевого факта) | -> КИ (8.3) | Даём недостающую теорию |
| Нет пробелов, но решение поверхностно | -> ПТ (8.5) | Углубляем противоречием |
| Несколько конкурирующих идей | -> ПМ (8.4) | Проверить каждую микрозаданием |
| Все гипотезы ошибочны, но ученик уверен | -> ПТ (8.5) | Показать противоречие |
| Ученик сам просит информации | -> КИ (8.3) | Даём теорию |

---

#### Шаг 8.3 — Ключевая информация / Теория (КИ)

| Параметр | Значение |
|---|---|
| **Название** | `provide_key_information` |
| **Код состояния** | `KI` |
| **Что делает система** | Даёт ТОЧЕЧНУЮ теорию — только ту, которой не хватает для проверки гипотезы или решения проблемы. Не «вот вся теория», а «вот ключ, которого не хватало». Формат — из `profile.theory_format_preference`. |
| **Сообщение пользователю** | Конкретное объяснение с примером в предпочитаемом формате. Пример: «Таблица истинности для импликации: A => B ложна ТОЛЬКО когда A истинно, а B ложно. Как обман обещания — вы обещали, но не сделали.» |

**Таблица переходов из КИ:**

| Контекст | Следующее состояние | Логика |
|---|---|---|
| Первая порция КИ по теме | -> ПМ (8.4) | Немедленное применение |
| Вторая/третья порция КИ | -> ГП (8.2) | Как изменились гипотезы? |
| Ученик проявил интерес к смежной теме | -> ПТ (8.5) | Расширяем контекст |
| Ученик пассивен после КИ | -> ПМ (8.4) | Обязательное применение |

---

#### Шаг 8.4 — Применение (ПМ)

| Параметр | Значение |
|---|---|
| **Название** | `apply_knowledge` |
| **Код состояния** | `PM` |
| **Что делает система** | Даёт практическое задание, где нужно применить полученную КИ. Задание — маленький шаг в решении общей проблемы. |
| **Сообщение пользователю** | Конкретное задание. Пример: «Определите истинность: (2*2=4) => (3*3=9); (2*2=5) => (3*3=10).» |

**Таблица переходов из ПМ:**

| Результат | Следующее состояние | Логика |
|---|---|---|
| Успешно + проблема почти решена | -> СЗ (8.6) | Переход к синтезу |
| Успешно + проблема сложная | -> ПТ (8.5) | Углубляем |
| Неуспешно из-за непонимания | -> КИ (8.3) | Другой аспект теории |
| Неуспешно из-за невнимательности | -> ПЗ (8.8) | Наводящий вопрос |
| Неуспешно, но ученик понимает почему | -> ГП (8.2) | Новые гипотезы |

---

#### Шаг 8.5 — Противоречие (ПТ)

| Параметр | Значение |
|---|---|
| **Название** | `present_contradiction` |
| **Код состояния** | `PT` |
| **Что делает система** | Намеренно показывает ограниченность текущего решения, ставит в тупик более сложным случаем или задаёт каверзный вопрос. |
| **Сообщение пользователю** | Пример: «А теперь проверьте: (A => B) <=> (not A or B). Всегда ли это верно? Постройте таблицы для обеих частей.» |

**Таблица переходов из ПТ:**

| Реакция | Следующее состояние | Логика |
|---|---|---|
| Интеллектуальный интерес, попытка разрешить | -> ГП (8.2) | Новые гипотезы |
| Растерянность, фрустрация | -> ПЗ (8.8) -> КИ (8.3) | Поддержка + теория |
| Игнорирование противоречия | -> ПТ (8.5) | Усилить конфликт |
| Успешное разрешение | -> СЗ (8.6) | Итоговый синтез |
| Частичное разрешение | -> ПМ (8.4) | Проверить новое понимание |

---

#### Шаг 8.6 — Синтез (СЗ)

| Параметр | Значение |
|---|---|
| **Название** | `synthesize` |
| **Код состояния** | `SZ` |
| **Что делает система** | Просит ученика собрать все открытия в единый ответ на исходную проблему (ПП). |
| **Сообщение пользователю** | «Теперь соберите воедино всё, что мы разобрали. Сформулируйте полное решение исходной задачи.» |

**Таблица переходов из СЗ:**

| Результат | Следующее состояние | Логика |
|---|---|---|
| Полный и логичный ответ | -> РФ (8.7) | Рефлексия |
| Неполный, но ученик осознаёт пробелы | -> ПЗ (8.8) | Подсказка |
| Неполный без осознания | -> ПТ (8.5) | Показать последствия |
| Ошибочный | -> КИ (8.3) | Вернуться к теории |
| Формальный, без глубины | -> РФ (8.7) | Рефлексия углубит |

---

#### Шаг 8.7 — Рефлексия (РФ)

| Параметр | Значение |
|---|---|
| **Название** | `reflect` |
| **Код состояния** | `RF` |
| **Что делает система** | Задаёт вопросы не «что ты узнал?», а «как ты пришёл к решению?», «какой шаг был самым трудным?». Формирует мета-навык. |
| **Сообщения пользователю** | 1. «Какой шаг был самым сложным и почему?» 2. «Почему [метод] — надёжный способ проверки?» 3. «Где в жизни/работе вы встречаете подобные ситуации?» |

**Таблица переходов из РФ:**

| Результат | Следующее состояние | Логика |
|---|---|---|
| Глубокая рефлексия с инсайтами | -> Новая ПП (8.1) следующей темы | Переход к новой теме |
| Поверхностная рефлексия | -> ПТ (8.5) | Противоречие о процессе |
| Отсутствует рефлексия | -> ПЗ (8.8) | Подсказка |
| Только эмоциональная | -> ГП (8.2) | Как использовать этот опыт? |

---

#### Шаг 8.8 — Подсказка (ПЗ)

| Параметр | Значение |
|---|---|
| **Название** | `provide_hint` |
| **Код состояния** | `PZ` |
| **Что делает система** | Даёт наводящий вопрос, отсылку к уже известному опыту или предложение взглянуть под другим углом. НЕ даёт прямой ответ. |
| **Сообщение пользователю** | Пример: «Вспомните, что значит "обмануть обещание"? Когда вы почувствуете, что вас обманули?» |

**Таблица переходов из ПЗ:**

| Реакция | Следующее состояние | Логика |
|---|---|---|
| Ученик активизировался | -> Возврат к предыдущему состоянию | Продолжаем |
| Ученик остался пассивен | -> ПЗ (8.8) другого типа | Другой угол |
| Ученик просит ещё помощи | -> КИ (8.3) | Даём теорию |
| Ученик злится/сопротивляется | -> ПТ (8.5) | Обсуждаем сопротивление |

---

## СВОДНАЯ ДИАГРАММА СОСТОЯНИЙ БЛОКА 8

```
                    +-------------------------------------+
                    |          INIT (8.0)                  |
                    +----------------+--------------------+
                                     | всегда
                                     v
                    +-------------------------------------+
         +--------->|          ПП (8.1)                   |<----- из РФ (новая тема)
         |          |   Практическая проблема              |
         |          +---+------+------+------+------------+
         |              |      |      |      |
         |       гипотеза  не знаю  вопрос  решение
         |              |      |      |      |
         |              v      v      v      v
         |          +------+ +----+ +----+ +----+
         |          | ГП   | | ПЗ | | КИ | | ПТ |
         |          |(8.2) | |8.8 | |8.3 | |8.5 |
         |          +--+---+ +--+-+ +-+--+ +-+--+
         |             |       |     |      |
         |             v       |     v      |
         |      +----------+   |  +------+  |
         |      | КИ / ПТ  |   |  | ПМ   |  |
         |      | / ПМ     |   |  |(8.4) |  |
         |      +----+-----+   |  +--+---+  |
         |           |         |     |      |
         |           v         |     v      |
         |        +------+    |  +------+   |
         |        | ПМ   |----+  | СЗ   |<--+
         |        |(8.4) |       |(8.6) |
         |        +--+---+      +--+---+
         |           |              |
         |           +-------+------+
         |                   v
         |             +----------+
         |             |  РФ      |
         |             |  (8.7)   |
         |             +----+-----+
         |                  |
         |        глубокая  |  поверхностная
         |                  |
         +------------------+
```

---

## СВОДКА: МАППИНГ ШАГОВ НА ПРОГРАММНЫЕ МОДУЛИ

| Фаза | Блок | Шаги | Тип модуля | Описание |
|---|---|---|---|---|
| A | 1-5 | 1.1-5.3 | `DataCollector` | Диалоговый сборщик данных (14 шагов с вопросами) |
| B | 6 | 6.1-6.3 | `ProfileBuilder` | Агрегация профиля + формулирование компетенций + ЗУН |
| B | 7 | 7.1-7.3 | `TrackGenerator` | Генерация учебных единиц + иерархия + сборка трека |
| C | 8 | 8.0-8.8 | `LessonEngine` | Конечный автомат проведения занятий (8 состояний) |

---

## ПРИЛОЖЕНИЕ A: ПОЛНАЯ ТАБЛИЦА ПЕРЕХОДОВ СОСТОЯНИЙ (для реализации FSM)

| Текущее | Ответ ученика | Следующее | Действие системы |
|---------|--------------------------------------|-----------|-------------------------------------|
| ПП | гипотеза | ГП | фиксируем все гипотезы |
| ПП | не знаю / молчит | ПЗ->ПП/ГП | стимулирующая подсказка |
| ПП | уточняющий вопрос | КИ | точечная теория |
| ПП | готовое решение | ПТ | усложняем противоречием |
| ГП | есть пробел | КИ | даём недостающий факт |
| ГП | поверхностно | ПТ | углубляем |
| ГП | несколько идей | ПМ | проверяем каждую |
| ГП | всё ошибочно, но уверен | ПТ | показываем противоречие |
| ГП | просит информации | КИ | даём теорию |
| КИ | первая порция | ПМ | немедленное применение |
| КИ | вторая+ порция | ГП | как изменились гипотезы? |
| КИ | интерес к смежному | ПТ | расширяем контекст |
| КИ | пассивен | ПМ | обязательное применение |
| ПМ | успех + проблема почти решена | СЗ | синтез |
| ПМ | успех + проблема сложная | ПТ | углубляем |
| ПМ | неуспех: непонимание | КИ | другой аспект теории |
| ПМ | неуспех: невнимательность | ПЗ | наводящий вопрос |
| ПМ | неуспех, но понимает почему | ГП | новые гипотезы |
| ПТ | интерес | ГП | новые гипотезы |
| ПТ | растерянность | ПЗ->КИ | поддержка + теория |
| ПТ | игнорирование | ПТ | усилить конфликт |
| ПТ | успешное разрешение | СЗ | итоговый синтез |
| ПТ | частичное разрешение | ПМ | проверить новое понимание |
| СЗ | полный и логичный | РФ | рефлексия |
| СЗ | неполный, осознаёт | ПЗ | подсказка |
| СЗ | неполный, не осознаёт | ПТ | показать последствия |
| СЗ | ошибочный | КИ | вернуться к теории |
| СЗ | формальный | РФ | рефлексия углубит |
| РФ | глубокая | ПП(new) | следующая тема |
| РФ | поверхностная | ПТ | противоречие о процессе |
| РФ | отсутствует | ПЗ | подсказка к рефлексии |
| РФ | только эмоциональная | ГП | как использовать опыт? |
| ПЗ | активизировался | <-prev | возврат к предыдущему |
| ПЗ | пассивен | ПЗ(alt) | другой угол |
| ПЗ | просит помощи | КИ | конкретная теория |
| ПЗ | злится | ПТ | обсуждаем сопротивление |

---

## ПРИЛОЖЕНИЕ B: КЛЮЧЕВЫЕ ТИПЫ ДАННЫХ (TypeScript)

```typescript
// ============================================================
// ФАЗА A: Входные данные (сбор от пользователя)
// ============================================================

interface Task {
  id: string;
  description: string;
  complexity_rank: number; // 1 = самая простая
}

interface Subtask {
  id: string;
  description: string;
  parent_task_id: string;
  required_knowledge: string[];
  required_skills: string[];
}

interface Barrier {
  id: string;
  description: string;
  related_task_id: string;
  barrier_type: 'conceptual' | 'procedural' | 'motivational';
}

interface Concept {
  id: string;
  term: string;
  confusion_description: string;
}

interface PracticeWindow {
  time_of_day: string;       // "morning", "evening"
  duration_minutes: number;
  device: string;            // "phone", "computer"
}

interface Schedule {
  day_of_week: string;       // "monday", "saturday" ...
  available_minutes: number;
}

interface Criterion {
  id: string;
  description: string;
  measurable: boolean;
  metric: string;            // "accuracy >= 0.8"
}

// ============================================================
// ФАЗА A: Агрегированный профиль
// ============================================================

interface StudentProfile {
  // Шаг 1.1
  role: string;
  experience_level: 'beginner' | 'intermediate' | 'expert';
  formal_education: string;
  identified_risks: string[];

  // Шаг 1.2
  motivation_external: string;
  motivation_internal: string;
  goal_type: 'applied' | 'fundamental' | 'mixed';

  // Шаг 1.3
  desired_outcomes: string[];
  target_context: string;

  // Шаги 2.1-2.4
  target_tasks: Task[];
  task_hierarchy: Task[];
  peak_task: Task;
  subtasks: Subtask[];
  primary_context: string;
  secondary_context: string;
  context_type: 'academic' | 'professional' | 'personal' | 'mixed';

  // Шаги 3.1-3.3
  current_approach: string;
  approach_gaps: string[];
  key_barriers: Barrier[];
  confusing_concepts: Concept[];

  // Шаги 3.4, 4.1-4.4
  theory_format_preference: 'visual_schemas' | 'examples_first' | 'video' | 'discussion' | 'mixed';
  theory_format_details: string;
  best_material_reference: string;
  instruction_format: string[];
  practice_format: string[];
  feedback_type: string[];
  daily_practice_minutes: number;
  practice_windows: PracticeWindow[];
  needs_reminder: boolean;
  mastery_signals: string[];
  support_tools: string[];

  // Шаги 5.1-5.3
  weekly_hours: number;
  schedule: Schedule[];
  learning_format: 'self_paced' | 'mentored' | 'group' | 'blended';
  support_channel: string;
  success_criteria: Criterion[];
}

// ============================================================
// ФАЗА B: Генерация курса
// ============================================================

interface Competency {
  id: string;
  description: string;      // "Способен [действие] в условиях [контекст]"
  source_tasks: Task[];
  level: 'basic' | 'intermediate' | 'advanced';
}

interface KSA_Entry {
  id: string;
  type: 'knowledge' | 'skill' | 'habit';
  description: string;
  competency_id: string;
}

type KSA_Matrix = Record<string, {
  knowledge: KSA_Entry[];
  skills: KSA_Entry[];
  habits: KSA_Entry[];
}>;

interface LearningUnit {
  id: string;
  type: 'theory' | 'practice' | 'automation';
  title: string;
  description: string;
  content: string;           // сгенерированный контент учебной единицы
  source_ksa_ids: string[];
  format: string;            // "visual_schema", "checklist", "micro_exercise"
  estimated_minutes: number;
  level: 'basic' | 'intermediate' | 'advanced';
  prerequisites: string[];   // id других LearningUnit
}

interface DailyExercise {
  description: string;
  duration_minutes: number;
  time_of_day: string;
}

interface Session {
  day_of_week: string;
  duration_minutes: number;
  type: 'theory' | 'practice' | 'automation';
  units: LearningUnit[];
}

interface Week {
  week_number: number;
  level: 'basic' | 'intermediate' | 'advanced' | 'integration';
  theme: string;
  learning_goal: string;
  sessions: Session[];
  daily_exercises: DailyExercise[];
  week_kpi: string;
  support_tools: string[];
}

interface Track {
  title: string;
  total_weeks: number;
  total_hours: number;
  competencies: Competency[];
  ksa_matrix: KSA_Matrix;
  weeks: Week[];
  final_assessment: {
    type: string;
    success_threshold: string;
    linked_criteria: Criterion[];
  };
}

// ============================================================
// ФАЗА C: Конечный автомат занятий (Lesson Engine)
// ============================================================

type LessonState = 'PP' | 'GP' | 'KI' | 'PM' | 'PT' | 'SZ' | 'RF' | 'PZ';

type StudentResponseType =
  // Из ПП
  | 'hypothesis' | 'dont_know' | 'clarification_question' | 'ready_solution'
  // Из ГП
  | 'has_gap' | 'superficial' | 'multiple_ideas' | 'wrong_but_confident' | 'asks_for_info'
  // Из КИ
  | 'first_portion' | 'subsequent_portion' | 'interest_in_related' | 'passive'
  // Из ПМ
  | 'success_almost_done' | 'success_complex' | 'fail_misunderstanding'
  | 'fail_carelessness' | 'fail_but_understands_why'
  // Из ПТ
  | 'intellectual_interest' | 'confusion' | 'ignoring' | 'resolved' | 'partial_resolution'
  // Из СЗ
  | 'complete_logical' | 'incomplete_aware' | 'incomplete_unaware' | 'erroneous' | 'formal'
  // Из РФ
  | 'deep_reflection' | 'shallow_reflection' | 'no_reflection' | 'emotional_only'
  // Из ПЗ
  | 'activated' | 'still_passive' | 'asks_more_help' | 'frustrated';

interface Transition {
  from_state: LessonState;
  response_type: StudentResponseType;
  to_state: LessonState;
  system_action: string;
}

interface LessonHistoryEntry {
  state: LessonState;
  student_input: string;
  system_output: string;
  response_type: StudentResponseType;
  timestamp: string;
}

interface LessonContext {
  current_state: LessonState;
  previous_state: LessonState | null;
  unit: LearningUnit;
  problem_statement: string;
  hypotheses: string[];
  ki_portions_given: number;
  attempt_count: number;
  hints_used: number;
  history: LessonHistoryEntry[];
}

// ============================================================
// Основной контроллер - интерфейс модулей
// ============================================================

interface DataCollector {
  /** Фаза A: последовательно задаёт вопросы и собирает ответы */
  runInterview(): Promise<StudentProfile>;
}

interface ProfileBuilder {
  /** Шаг 6.1: агрегация профиля */
  buildProfile(rawData: StudentProfile): StudentProfile;
  /** Шаг 6.2: формулирование компетенций */
  formulateCompetencies(profile: StudentProfile): Competency[];
  /** Шаг 6.3: декомпозиция на ЗУН */
  decomposeToKSA(competencies: Competency[], profile: StudentProfile): KSA_Matrix;
}

interface TrackGenerator {
  /** Шаг 7.1: генерация учебных единиц */
  generateUnits(ksa: KSA_Matrix, profile: StudentProfile): LearningUnit[];
  /** Шаг 7.2: построение иерархии */
  buildHierarchy(units: LearningUnit[], profile: StudentProfile): Level[];
  /** Шаг 7.3: сборка трека */
  assembleTrack(levels: Level[], units: LearningUnit[], profile: StudentProfile): Track;
}

interface LessonEngine {
  /** Шаг 8.0: инициализация */
  initLesson(unit: LearningUnit): LessonContext;
  /** Классификация ответа ученика */
  classifyResponse(context: LessonContext, response: string): StudentResponseType;
  /** Определение следующего состояния по таблице переходов */
  getNextState(context: LessonContext, responseType: StudentResponseType): LessonState;
  /** Генерация сообщения системы для текущего состояния */
  generateMessage(context: LessonContext): string;
  /** Основной цикл занятия */
  runLesson(unit: LearningUnit): Promise<void>;
}
```

---

## ПРИЛОЖЕНИЕ C: ПОРЯДОК ВЫЗОВА МОДУЛЕЙ (PIPELINE)

```
1. DataCollector.runInterview()
   -> StudentProfile (сырые данные)

2. ProfileBuilder.buildProfile(rawData)
   -> StudentProfile (агрегированный)

3. ProfileBuilder.formulateCompetencies(profile)
   -> Competency[]

4. ProfileBuilder.decomposeToKSA(competencies, profile)
   -> KSA_Matrix

5. TrackGenerator.generateUnits(ksa, profile)
   -> LearningUnit[]

6. TrackGenerator.buildHierarchy(units, profile)
   -> Level[]

7. TrackGenerator.assembleTrack(levels, units, profile)
   -> Track

8. FOR EACH week IN Track.weeks:
     FOR EACH session IN week.sessions:
       FOR EACH unit IN session.units:
         LessonEngine.initLesson(unit)
         LessonEngine.runLesson(unit)  // интерактивный цикл FSM
```
