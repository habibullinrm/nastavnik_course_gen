"""Промпт для LLM-as-Judge оценки качества результатов pipeline."""

import json
from typing import Any


# Описания ожиданий для каждого шага — что именно проверять
STEP_EXPECTATIONS: dict[str, str] = {
    "B1_validate": """
- Все обязательные поля заполнены (validation_status, effective_level, estimated_weeks, time budgets)
- effective_level логически соответствует комбинации experience_level и diagnostic_result
- estimated_weeks адекватен сложности задач и уровню ученика (4-52)
- time budget корректно вычислен (weekly_hours * 60 * estimated_weeks)
- Предупреждения (warnings) указывают на реальные проблемы профиля
- original_profile сохранён без потерь данных""",

    "B2_competencies": """
- Компетенции покрывают ВСЕ target_tasks и desired_outcomes из профиля
- Каждая компетенция имеет чёткую, измеримую формулировку
- Уровни компетенций (foundational → intermediate → advanced → integrative) логичны
- Есть интегративная компетенция (integral_competency_id), объединяющая ключевые навыки
- competency_task_map и competency_outcome_map полностью заполнены
- Количество компетенций адекватно (обычно 4-12 для типичного курса)
- Нет дублирующихся или слишком размытых компетенций""",

    "B3_ksa_matrix": """
- KSA-матрица покрывает все компетенции из B2
- Knowledge, Skills, Habits чётко разделены по типам
- Каждый элемент привязан к компетенции (competency_id)
- Bloom levels адекватны уровню ученика
- Нет дублирования между knowledge/skills/habits
- Количество элементов пропорционально сложности курса""",

    "B4_learning_units": """
- Кластеры логически группируют связанные темы
- Theory units покрывают все knowledge items из B3
- Practice units покрывают все skills из B3
- Каждый unit имеет чёткое описание и связь с KSA
- Порядок кластеров соответствует логике обучения (от простого к сложному)
- Нет пропущенных тем или избыточных повторений""",

    "B5_hierarchy": """
- Уровни (levels) выстроены от базового к продвинутому
- total_weeks соответствует estimated_weeks из B1
- Распределение времени между уровнями адекватно
- Каждый уровень содержит логически связанные units из B4
- Прогрессия сложности плавная, без резких скачков""",

    "B6_problem_formulations": """
- Проблемные формулировки (PBL) соответствуют контексту ученика
- Каждая формулировка связана с конкретными компетенциями
- Сложность задач соответствует уровню ученика
- Формулировки мотивирующие и практико-ориентированные
- Покрытие всех ключевых тем курса""",

    "B7_schedule": """
- Количество недель соответствует total_weeks из B5
- Еженедельная нагрузка не превышает weekly_hours из профиля
- Чекпоинты расставлены равномерно
- Порядок тем соответствует иерархии из B5
- Баланс теории и практики адекватен
- Учтены practice_windows из профиля (если указаны)""",

    "B8_validation": """
- Все критические проверки пройдены (overall_valid)
- critical_failures = 0 для качественного результата
- Проверена целостность связей между всеми шагами B1-B7
- Покрытие задач и outcomes полное
- Временные бюджеты сбалансированы""",
}


def get_judge_prompt(
    step_name: str,
    parsed_result: dict[str, Any],
    input_data: dict[str, Any] | None = None,
) -> str:
    """Сформировать промпт для LLM-as-Judge оценки."""

    step_expectations = STEP_EXPECTATIONS.get(step_name, "Нет специфичных ожиданий для этого шага.")

    result_json = json.dumps(parsed_result, ensure_ascii=False, indent=2)
    # Ограничиваем размер, чтобы не превысить контекст
    if len(result_json) > 6000:
        result_json = result_json[:6000] + "\n... (обрезано)"

    input_json = json.dumps(input_data or {}, ensure_ascii=False, indent=2)
    if len(input_json) > 3000:
        input_json = input_json[:3000] + "\n... (обрезано)"

    return f"""Ты — эксперт по оценке качества генерации учебных треков. Твоя задача — оценить результат шага {step_name} pipeline генерации персонализированного курса.

## Входные данные шага
```json
{input_json}
```

## Результат для оценки
```json
{result_json}
```

## Критерии оценки для шага {step_name}
{step_expectations}

## Инструкции

Проанализируй результат по следующим аспектам:

1. **Полнота** — все ли необходимые данные присутствуют, нет ли пропущенных полей или пустых значений
2. **Корректность** — логически верны ли данные, нет ли противоречий с входными данными
3. **Качество** — насколько хорошо результат соответствует критериям шага, адекватны ли формулировки
4. **Связность** — корректно ли результат связан с предыдущими шагами pipeline (через входные данные)
5. **Проблемы** — конкретные ошибки, недочёты, пропуски, которые нужно исправить

## Формат ответа

Ответь ТОЛЬКО валидным JSON (без markdown-обёртки):
{{
    "score": <целое число от 1 до 10>,
    "summary": "<краткая общая оценка в 1-2 предложениях>",
    "strengths": ["<что сделано хорошо>", ...],
    "problems": ["<конкретная проблема 1>", "<конкретная проблема 2>", ...],
    "suggestions": ["<рекомендация по улучшению 1>", ...],
    "reasoning": "<подробное обоснование оценки: что хорошо, что плохо, почему такой балл>"
}}

Шкала оценки:
- 9-10: Отлично — результат полный, корректный, хорошо структурированный
- 7-8: Хорошо — есть мелкие недочёты, но в целом качественно
- 5-6: Удовлетворительно — заметные проблемы, но базовая структура верна
- 3-4: Плохо — серьёзные ошибки, неполные данные, нарушена логика
- 1-2: Критично — результат непригоден, требуется полная переработка

ВАЖНО: Отвечай ТОЛЬКО на русском языке. Будь конкретен в описании проблем — указывай точные поля, значения, несоответствия.
Начни ответ с {{ и закончи }}"""
