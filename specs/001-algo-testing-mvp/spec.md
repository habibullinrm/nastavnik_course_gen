# Feature Specification: Сервис тестирования алгоритма генерации учебных треков

**Feature Branch**: `001-algo-testing-mvp`
**Created**: 2026-02-12
**Status**: Draft
**Input**: User description: "Версия для тестирования и доработки алгоритмов"

## Clarifications

### Session 2026-02-12

- Q: Какой уровень детализации Фазы B реализуем в MVP? → A: Полный pipeline B1-B8 со всеми промежуточными структурами (компетенции, ЗУН, учебные единицы, lesson blueprints, расписание).
- Q: В каком формате загружаются входные данные профиля? → A: JSON вместо CSV — нативная поддержка всех типов `StudentProfile` (массивы, вложенные объекты, enum).
- Q: Нужно ли сохранять результаты генерации в БД между сессиями? → A: В БД сохраняются профили и финальные треки; промежуточные шаги B1-B8 — только в памяти сессии.

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Загрузка профиля и генерация трека (Priority: P1)

Разработчик загружает JSON-файл с заполненными полями профиля
учащегося (результат Фазы A). Система валидирует файл: проверяет
наличие обязательных полей, корректность типов данных, валидность
значений. После успешной валидации разработчик запускает генерацию
учебного трека — полный pipeline Фазы B (шаги B1-B8). Система
последовательно выполняет: валидацию профиля (B1), формулирование
компетенций (B2), декомпозицию в ЗУН (B3), проектирование учебных
единиц (B4), построение иерархии (B5), проблемные формулировки (B6),
сборку расписания (B7) и валидацию трека (B8). По завершении
отображается готовый `PersonalizedTrack`.

**Why this priority**: Загрузка данных и генерация — ядро сервиса.
Без возможности загрузить профиль и запустить генерацию остальные
функции бесполезны.

**Independent Test**: Загрузить корректный JSON, запустить генерацию,
проверить, что на выходе отображается полный `PersonalizedTrack`
с компетенциями, матрицей ЗУН, учебными единицами и расписанием.

**Acceptance Scenarios**:

1. **Given** разработчик открыл веб-интерфейс, **When** он загружает
   корректный JSON-файл с профилем учащегося, **Then** система
   валидирует файл и отображает подтверждение успешной загрузки
   с извлечённым `StudentProfile`.
2. **Given** JSON загружен и провалидирован, **When** разработчик
   нажимает «Сгенерировать трек», **Then** система выполняет
   полный pipeline B1-B8 и отображает результат: компетенции,
   матрицу ЗУН, учебные единицы, иерархию уровней, lesson
   blueprints и понедельное расписание.
3. **Given** разработчик загружает JSON с отсутствующими обязательными
   полями, **When** система валидирует файл, **Then** отображается
   список ошибок с указанием, какие поля отсутствуют или невалидны.
4. **Given** JSON содержит все CRITICAL-поля, но некоторые
   IMPORTANT-поля отсутствуют, **When** система валидирует файл,
   **Then** загрузка проходит успешно с предупреждением о
   потенциально менее точной персонализации.

---

### User Story 2 — Просмотр результатов генерации (Priority: P2)

Разработчик просматривает сгенерированный учебный трек в
структурированном виде: древовидное отображение курса с
детализацией по каждому уровню (компетенции → ЗУН → учебные
единицы → темы → подтемы → учебные действия → длительность).
Также отображаются метаданные генерации (версия алгоритма, время
генерации, входные параметры) и индикаторы использованных/
неиспользованных полей профиля.

**Why this priority**: Возможность изучить результат генерации —
необходимое условие для оценки качества алгоритма и принятия
решений о доработке.

**Independent Test**: После генерации трека проверить, что
отображается дерево курса со всеми уровнями (компетенции, ЗУН,
учебные единицы, расписание) и видны метаданные генерации.

**Acceptance Scenarios**:

1. **Given** трек сгенерирован, **When** разработчик открывает
   результаты, **Then** он видит древовидную структуру со всеми
   уровнями: компетенции → ЗУН → учебные единицы → темы →
   подтемы → учебные действия.
2. **Given** разработчик просматривает дерево курса, **When** он
   раскрывает конкретную компетенцию, **Then** отображаются
   связанные Знания, Умения, Навыки и учебные единицы.
3. **Given** трек сгенерирован, **When** разработчик просматривает
   метаданные, **Then** он видит версию алгоритма, timestamp
   генерации и входные параметры из профиля.
4. **Given** трек сгенерирован, **When** разработчик просматривает
   индикаторы полей, **Then** он видит, какие поля профиля были
   использованы при генерации, а какие — нет.
5. **Given** трек сгенерирован, **When** разработчик открывает
   понедельное расписание, **Then** он видит распределение учебных
   единиц по неделям и дням с длительностями.

---

### User Story 3 — Контроль качества: пакетная генерация и сравнение (Priority: P3)

Разработчик запускает пакетную генерацию: из одного JSON-файла
система создаёт N версий учебного трека (от 1 до 100), выполняя
полный pipeline B1-B8 для каждой версии. После завершения система
отображает отчёт контроля качества: сводную таблицу CDV
(коэффициент различия версий) между парами, детализацию по темам
(стабильные/нестабильные) и итоговую рекомендацию о стабильности
алгоритма.

**Why this priority**: Контроль качества — ключевая функция для
доработки алгоритмов, но она требует работающей одиночной генерации.

**Independent Test**: Загрузить JSON, запустить 5 генераций, проверить,
что отображается сводная таблица CDV и рекомендация по стабильности.

**Acceptance Scenarios**:

1. **Given** JSON загружен, **When** разработчик указывает количество
   генераций (например, 10) и запускает пакетную генерацию, **Then**
   система создаёт 10 версий трека и отображает прогресс.
2. **Given** пакетная генерация завершена, **When** разработчик
   открывает отчёт, **Then** он видит сводную таблицу CDV для
   каждой пары версий.
3. **Given** отчёт отображается, **When** разработчик просматривает
   детализацию по темам, **Then** он видит частоту встречаемости
   каждой темы (N из M версий), топ-5 нестабильных и топ-5
   стабильных тем.
4. **Given** отчёт содержит итоговые индикаторы, **When**
   средний CDV < 15%, **Then** система выводит рекомендацию
   «стабильный алгоритм»; **When** CDV > 30%, **Then**
   рекомендацию «требует доработки».

---

### User Story 4 — Экспорт результатов (Priority: P4)

Разработчик экспортирует результаты генерации (одиночной или
пакетной) в формате JSON для дальнейшего анализа или
документирования.

**Why this priority**: Экспорт важен для offline-анализа, но
не блокирует основные сценарии тестирования.

**Independent Test**: Сгенерировать трек, нажать «Экспорт»,
проверить, что скачивается файл с полной структурой трека.

**Acceptance Scenarios**:

1. **Given** трек сгенерирован, **When** разработчик выбирает
   «Экспорт», **Then** скачивается файл
   `track_[topic]_[timestamp].json` с полной структурой
   `PersonalizedTrack` и метаданными генерации.
2. **Given** пакетная генерация завершена, **When** разработчик
   экспортирует отчёт контроля качества, **Then** скачивается
   JSON-файл с CDV-метриками, детализацией по темам и итоговыми
   индикаторами.
3. **Given** пакетная генерация завершена, **When** разработчик
   экспортирует все версии треков, **Then** скачивается архив
   со всеми `PersonalizedTrack` и QA-отчётом.

---

### Edge Cases

- Что происходит, если JSON-файл пустой или невалидный JSON?
  Система MUST отобразить ошибку парсинга с указанием позиции.
- Что происходит, если LLM возвращает невалидный ответ (не
  парсится в ожидаемый формат)? Система MUST отобразить ошибку
  и предложить повторить генерацию.
- Что происходит при превышении лимита токенов LLM? Система
  MUST отобразить информативную ошибку с рекомендацией упростить
  профиль.
- Что происходит, если пакетная генерация из 100 запусков
  прерывается на 50-м (ошибка сети/LLM)? Система MUST сохранить
  уже готовые версии и позволить просмотреть частичный отчёт.
- Что происходит, если JSON содержит некорректные типы данных
  (строка вместо числа, невалидный enum)? Система MUST указать
  конкретные поля и ожидаемые типы.
- Что происходит, если все N версий трека идентичны (CDV = 0%)?
  Система MUST корректно отобразить отчёт с рекомендацией
  «полностью стабильный алгоритм».
- Что происходит, если валидация B8 обнаруживает критические
  ошибки? Система MUST отобразить список ошибок с указанием
  шага-источника и предложить перезапустить генерацию.

## Requirements *(mandatory)*

### Functional Requirements

**Загрузка и обработка данных:**

- **FR-001**: Система MUST принимать JSON-файл с полями профиля
  учащегося (`StudentProfile`) в качестве входных данных.
- **FR-002**: Система MUST валидировать загруженный JSON: проверка
  наличия всех CRITICAL-полей, корректности типов данных и
  валидности значений согласно спецификации Фазы A.
- **FR-003**: Система MUST извлекать данные из JSON и формировать
  структурированный объект `StudentProfile`.
- **FR-004**: Система MUST отображать предупреждения при отсутствии
  IMPORTANT-полей и ошибки при отсутствии CRITICAL-полей.

**Генерация учебного трека (полный pipeline B1-B8):**

- **FR-005**: Система MUST выполнять полный pipeline Фазы B
  (шаги B1-B8) с загруженным профилем: валидация и обогащение
  профиля (B1), формулирование компетенций (B2), декомпозиция
  в матрицу ЗУН (B3), проектирование учебных единиц (B4),
  построение иерархии и уровней (B5), проектирование проблемных
  формулировок (B6), сборка трека в расписание (B7), валидация
  трека (B8).
- **FR-006**: Система MUST формировать `PersonalizedTrack`,
  включающий компетенции, матрицу ЗУН, учебные единицы,
  иерархию уровней (Базовый → Средний → Продвинутый →
  Интеграционный), lesson blueprints и понедельное расписание.

**Просмотр результатов:**

- **FR-007**: Система MUST отображать результат генерации в виде
  древовидной структуры с возможностью раскрытия каждого уровня
  (компетенции → ЗУН → учебные единицы → темы → расписание).
- **FR-008**: Система MUST отображать детализацию по каждой
  компетенции: связанные Знания, Умения, Навыки, учебные
  единицы, длительность.
- **FR-009**: Система MUST отображать метаданные генерации: версию
  алгоритма, timestamp, входные параметры из профиля.
- **FR-010**: Система MUST отображать индикаторы использованных
  и неиспользованных полей профиля при генерации.

**Экспорт:**

- **FR-011**: Система MUST позволять экспортировать результат
  генерации (`PersonalizedTrack`) в формате JSON.
- **FR-012**: Экспортируемый файл MUST содержать полную структуру
  трека и метаданные генерации. Именование:
  `track_[topic]_[timestamp].json`.
- **FR-013**: Система MUST позволять экспортировать QA-отчёт
  пакетной генерации в формате JSON.

**Контроль качества:**

- **FR-014**: Система MUST позволять запускать пакетную генерацию:
  от 1 до 100 версий трека из одного входного JSON.
- **FR-015**: Система MUST сравнивать версии на уровне тем:
  добавленные/удалённые темы, изменение порядка, изменение
  названий.
- **FR-016**: Система MUST выполнять углублённое сравнение:
  различия в подтемах, учебных действиях, длительности и
  приоритетах.
- **FR-017**: Система MUST рассчитывать коэффициент различия
  версий (CDV) по формуле с весами: структура тем (0.4),
  содержание подтем (0.3), состав учебных действий (0.3).
- **FR-018**: Система MUST формировать отчёт контроля качества:
  сводная таблица CDV по парам, частота тем по версиям, топ-5
  стабильных и нестабильных тем, средний CDV, стандартное
  отклонение CDV, итоговая рекомендация.

**Хранение данных:**

- **FR-019**: Система MUST сохранять загруженные профили
  (`StudentProfile`) в базу данных между сессиями.
- **FR-020**: Система MUST сохранять финальные сгенерированные
  треки (`PersonalizedTrack`) в базу данных между сессиями.
- **FR-021**: Промежуточные результаты шагов B1-B8 хранятся
  в памяти текущей сессии и НЕ персистятся в базу данных.

### Key Entities

- **StudentProfile**: Профиль учащегося, загруженный из JSON.
  Содержит все поля согласно спецификации Фазы A: тема, роль,
  уровень опыта, целевые задачи, барьеры, предпочтения, расписание,
  критерии успеха. Является входом для генерации. Сохраняется в БД.
- **PersonalizedTrack**: Результат одной генерации полным pipeline
  B1-B8. Содержит компетенции, матрицу ЗУН, учебные единицы,
  иерархию уровней, lesson blueprints, понедельное расписание,
  результаты валидации B8, метаданные генерации. Связан с одним
  `StudentProfile`. Сохраняется в БД.
- **QAReport**: Отчёт контроля качества по результатам пакетной
  генерации. Содержит CDV-метрики между парами версий, частоту
  тем, топ стабильных/нестабильных тем, итоговые индикаторы,
  рекомендацию. Связан с набором `PersonalizedTrack` из одного
  `StudentProfile`.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Разработчик может загрузить JSON, запустить генерацию
  и увидеть полный результат (компетенции, ЗУН, расписание)
  за не более 5 минут (не считая время работы LLM).
- **SC-002**: При загрузке невалидного JSON система отображает все
  ошибки валидации за одну попытку (не по одной).
- **SC-003**: Пакетная генерация 10 версий завершается и отображает
  полный QA-отчёт с CDV-метриками.
- **SC-004**: Итоговая рекомендация корректно классифицирует
  стабильность: «стабильный» при CDV < 15%, «требует доработки»
  при CDV > 30%.
- **SC-005**: Экспортированный JSON-файл содержит полную структуру
  `PersonalizedTrack` и может быть повторно загружен для анализа.
- **SC-006**: Дерево курса отображает полную иерархию: компетенции →
  ЗУН → учебные единицы → темы → подтемы → учебные действия
  с длительностью на каждом уровне.
- **SC-007**: Загруженные профили и сгенерированные треки доступны
  после перезапуска сервиса (персистентность в БД).

## Assumptions

- Это внутренний сервис для команды разработки, а не для конечных
  пользователей. Приоритет — функциональность и прозрачность
  результатов, а не визуальная полировка UI.
- Одновременно сервисом пользуется один разработчик (не требуется
  мультитенантность).
- JSON-файл с профилем готовится вручную или является выходом
  отдельного процесса Фазы A (вне скоупа данного сервиса).
- Спецификации алгоритмов в `docs/phase_a.md` (формат профиля)
  и `docs/phase_b.md` (алгоритм генерации) являются источником
  истины.
- LLM API доступен и имеет достаточные лимиты для пакетной
  генерации (до 100 запусков × 20-60 вызовов на трек).
- Сервис тестирует только Фазу B (генерацию трека). Фаза A
  (интерактивный сбор данных) и Фаза C (проведение уроков)
  вне скоупа.
- Промежуточные результаты шагов B1-B8 не требуют персистентности
  между сессиями; достаточно хранения в памяти для текущего
  сеанса работы.