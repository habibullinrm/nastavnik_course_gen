# Feature Specification: Сервис тестирования алгоритма генерации учебных треков

**Feature Branch**: `001-algo-testing-mvp`
**Created**: 2026-02-12
**Status**: Draft
**Input**: User description: "Версия для тестирования и доработки алгоритмов"

## Clarifications

### Session 2026-02-12

- Q: Какой уровень детализации Фазы B реализуем в MVP? → A: Полный pipeline B1-B8 со всеми промежуточными структурами (компетенции, ЗУН, учебные единицы, lesson blueprints, расписание).
- Q: В каком формате загружаются входные данные профиля? → A: JSON вместо CSV — нативная поддержка всех типов `StudentProfile` (массивы, вложенные объекты, enum).
- Q: Нужно ли сохранять результаты генерации в БД между сессиями? → A: В БД сохраняются профили и финальные треки; промежуточные шаги B1-B8 — только в памяти сессии.

### Session 2026-02-13

- Q: Как система должна обрабатывать ошибки LLM API (сетевые сбои, rate limits, timeouts)? → A: Retry 3 times with exponential backoff (1s, 2s, 4s), then fail with detailed error report.
- Q: Какой уровень observability требуется для отладки ML pipeline? → A: Database audit log - все промежуточные результаты B1-B8 сохраняются в БД с versioning для полной трассировки генерации.
- Q: Какой LLM provider использовать для Фазы B генерации треков? → A: DeepSeek API (OpenAI-compatible format, оптимальное соотношение цена/качество для MVP).
- Q: Какой максимально допустимый performance target для генерации одного PersonalizedTrack (исключая LLM API время)? → A: 2-5 минут - баланс между качественной валидацией/logging и приемлемым UX для внутреннего инструмента.
- Q: Какой retention policy применять к записям PipelineAuditLog в базе данных? → A: 30 дней с автоматической очисткой - достаточно для отладки, предотвращает неконтролируемый рост БД.

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Загрузка профиля и генерация трека (Priority: P1)

Разработчик загружает JSON-файл с заполненными полями профиля
учащегося (результат Фазы A). Система валидирует файл: проверяет
наличие обязательных полей, корректность типов данных, валидность
значений. После успешной валидации разработчик запускает генерацию
учебного трека — полный pipeline Фазы B (шаги B1-B8). Система
последовательно выполняет: валидацию профиля (B1), формулирование
компетенций (B2), декомпозицию в ЗУН (B3), проектирование учебных
единиц (B4), построение иерархии (B5), проблемные формулировки (B6),
сборку расписания (B7) и валидацию трека (B8). По завершении
отображается готовый `PersonalizedTrack`.

**Why this priority**: Загрузка данных и генерация — ядро сервиса.
Без возможности загрузить профиль и запустить генерацию остальные
функции бесполезны.

**Independent Test**: Загрузить корректный JSON, запустить генерацию,
проверить, что на выходе отображается полный `PersonalizedTrack`
с компетенциями, матрицей ЗУН, учебными единицами и расписанием.

**Acceptance Scenarios**:

1. **Given** разработчик открыл веб-интерфейс, **When** он загружает
   корректный JSON-файл с профилем учащегося, **Then** система
   валидирует файл и отображает подтверждение успешной загрузки
   с извлечённым `StudentProfile`.
2. **Given** JSON загружен и провалидирован, **When** разработчик
   нажимает «Сгенерировать трек», **Then** система выполняет
   полный pipeline B1-B8 и отображает результат: компетенции,
   матрицу ЗУН, учебные единицы, иерархию уровней, lesson
   blueprints и понедельное расписание.
3. **Given** разработчик загружает JSON с отсутствующими обязательными
   полями, **When** система валидирует файл, **Then** отображается
   список ошибок с указанием, какие поля отсутствуют или невалидны.
4. **Given** JSON содержит все CRITICAL-поля, но некоторые
   IMPORTANT-поля отсутствуют, **When** система валидирует файл,
   **Then** загрузка проходит успешно с предупреждением о
   потенциально менее точной персонализации.

---

### User Story 2 — Просмотр результатов генерации (Priority: P2)

Разработчик просматривает сгенерированный учебный трек в
структурированном виде: древовидное отображение курса с
детализацией по каждому уровню (компетенции → ЗУН → учебные
единицы → темы → подтемы → учебные действия → длительность).
Также отображаются метаданные генерации (версия алгоритма, время
генерации, входные параметры) и индикаторы использованных/
неиспользованных полей профиля.

**Why this priority**: Возможность изучить результат генерации —
необходимое условие для оценки качества алгоритма и принятия
решений о доработке.

**Independent Test**: После генерации трека проверить, что
отображается дерево курса со всеми уровнями (компетенции, ЗУН,
учебные единицы, расписание) и видны метаданные генерации.

**Acceptance Scenarios**:

1. **Given** трек сгенерирован, **When** разработчик открывает
   результаты, **Then** он видит древовидную структуру со всеми
   уровнями: компетенции → ЗУН → учебные единицы → темы →
   подтемы → учебные действия.
2. **Given** разработчик просматривает дерево курса, **When** он
   раскрывает конкретную компетенцию, **Then** отображаются
   связанные Знания, Умения, Навыки и учебные единицы.
3. **Given** трек сгенерирован, **When** разработчик просматривает
   метаданные, **Then** он видит версию алгоритма, timestamp
   генерации и входные параметры из профиля.
4. **Given** трек сгенерирован, **When** разработчик просматривает
   индикаторы полей, **Then** он видит, какие поля профиля были
   использованы при генерации, а какие — нет.
5. **Given** трек сгенерирован, **When** разработчик открывает
   понедельное расписание, **Then** он видит распределение учебных
   единиц по неделям и дням с длительностями.

---

### User Story 3 — Контроль качества: пакетная генерация и сравнение (Priority: P3)

Разработчик запускает пакетную генерацию: из одного JSON-файла
система создаёт N версий учебного трека (от 1 до 100), выполняя
полный pipeline B1-B8 для каждой версии. После завершения система
отображает отчёт контроля качества: сводную таблицу CDV
(коэффициент различия версий) между парами, детализацию по темам
(стабильные/нестабильные) и итоговую рекомендацию о стабильности
алгоритма.

**Why this priority**: Контроль качества — ключевая функция для
доработки алгоритмов, но она требует работающей одиночной генерации.

**Independent Test**: Загрузить JSON, запустить 5 генераций, проверить,
что отображается сводная таблица CDV и рекомендация по стабильности.

**Acceptance Scenarios**:

1. **Given** JSON загружен, **When** разработчик указывает количество
   генераций (например, 10) и запускает пакетную генерацию, **Then**
   система создаёт 10 версий трека и отображает прогресс.
2. **Given** пакетная генерация завершена, **When** разработчик
   открывает отчёт, **Then** он видит сводную таблицу CDV для
   каждой пары версий.
3. **Given** отчёт отображается, **When** разработчик просматривает
   детализацию по темам, **Then** он видит частоту встречаемости
   каждой темы (N из M версий), топ-5 нестабильных и топ-5
   стабильных тем.
4. **Given** отчёт содержит итоговые индикаторы, **When**
   средний CDV < 15%, **Then** система выводит рекомендацию
   «стабильный алгоритм»; **When** CDV > 30%, **Then**
   рекомендацию «требует доработки».

---

### User Story 4 — Экспорт результатов (Priority: P4)

Разработчик экспортирует результаты генерации (одиночной или
пакетной) в формате JSON для дальнейшего анализа или
документирования.

**Why this priority**: Экспорт важен для offline-анализа, но
не блокирует основные сценарии тестирования.

**Independent Test**: Сгенерировать трек, нажать «Экспорт»,
проверить, что скачивается файл с полной структурой трека.

**Acceptance Scenarios**:

1. **Given** трек сгенерирован, **When** разработчик выбирает
   «Экспорт», **Then** скачивается файл
   `track_[topic]_[timestamp].json` с полной структурой
   `PersonalizedTrack` и метаданными генерации.
2. **Given** пакетная генерация завершена, **When** разработчик
   экспортирует отчёт контроля качества, **Then** скачивается
   JSON-файл с CDV-метриками, детализацией по темам и итоговыми
   индикаторами.
3. **Given** пакетная генерация завершена, **When** разработчик
   экспортирует все версии треков, **Then** скачивается архив
   со всеми `PersonalizedTrack` и QA-отчётом.

---

### Edge Cases

- Что происходит, если JSON-файл пустой или невалидный JSON?
  Система MUST отобразить ошибку парсинга с указанием позиции.
- Что происходит, если LLM возвращает невалидный ответ (не
  парсится в ожидаемый формат)? Система MUST отобразить ошибку
  и предложить повторить генерацию.
- Что происходит при превышении лимита токенов LLM? Система
  MUST отобразить информативную ошибку с рекомендацией упростить
  профиль.
- Что происходит при сетевых ошибках или rate limits от LLM API?
  Система MUST выполнить 3 повторные попытки с exponential backoff
  (1s, 2s, 4s). После исчерпания попыток отобразить детальный
  отчёт об ошибке с информацией о номере шага B1-B8, количестве
  попыток и рекомендацией (проверить соединение, повторить позже).
- Что происходит, если пакетная генерация из 100 запусков
  прерывается на 50-м (ошибка сети/LLM)? Система MUST сохранить
  уже готовые версии и позволить просмотреть частичный отчёт.
- Что происходит, если JSON содержит некорректные типы данных
  (строка вместо числа, невалидный enum)? Система MUST указать
  конкретные поля и ожидаемые типы.
- Что происходит, если все N версий трека идентичны (CDV = 0%)?
  Система MUST корректно отобразить отчёт с рекомендацией
  «полностью стабильный алгоритм».
- Что происходит, если валидация B8 обнаруживает критические
  ошибки? Система MUST отобразить список ошибок с указанием
  шага-источника и предложить перезапустить генерацию.
- Что происходит, если пользователь нажимает «Остановить генерацию»
  во время выполнения шага B4? Система MUST завершить текущий шаг
  (не прерывать посреди LLM-вызова), сохранить все завершённые шаги
  (B1-B3), установить статус "cancelled" и уведомить UI через SSE.
- Что происходит, если SSE-соединение разрывается во время генерации?
  Frontend MUST определить завершение из состояния шагов (все 8 completed)
  как fallback, ограничить количество переподключений (макс. 10) и
  корректно отобразить результат.

## Requirements *(mandatory)*

### Functional Requirements

**Загрузка и обработка данных:**

- **FR-001**: Система MUST принимать JSON-файл с полями профиля
  учащегося (`StudentProfile`) в качестве входных данных.
- **FR-002**: Система MUST валидировать загруженный JSON: проверка
  наличия всех CRITICAL-полей, корректности типов данных и
  валидности значений согласно спецификации Фазы A.
- **FR-003**: Система MUST извлекать данные из JSON и формировать
  структурированный объект `StudentProfile`.
- **FR-004**: Система MUST отображать предупреждения при отсутствии
  IMPORTANT-полей и ошибки при отсутствии CRITICAL-полей.

**Генерация учебного трека (полный pipeline B1-B8):**

- **FR-005**: Система MUST выполнять полный pipeline Фазы B
  (шаги B1-B8) с загруженным профилем: валидация и обогащение
  профиля (B1), формулирование компетенций (B2), декомпозиция
  в матрицу ЗУН (B3), проектирование учебных единиц (B4),
  построение иерархии и уровней (B5), проектирование проблемных
  формулировок (B6), сборка трека в расписание (B7), валидация
  трека (B8).
- **FR-005a**: Система MUST запускать генерацию в фоновом режиме
  (background task через `asyncio.create_task`). POST /api/tracks/generate
  MUST возвращать HTTP 202 Accepted с `track_id` немедленно, не дожидаясь
  завершения pipeline. Клиент отслеживает прогресс через SSE endpoint.
- **FR-005b**: Система MUST предоставлять SSE endpoint
  GET /api/tracks/{id}/progress для пошагового отслеживания
  прогресса генерации в реальном времени. SSE-события:
  - `step_update` — текущий шаг (B1-B8), статус (running/completed/failed),
    описание, время выполнения, использованные токены, summary
  - `complete` — генерация завершена, итоговые метрики (total_duration_sec, total_tokens)
  - `cancelled` — генерация остановлена, список завершённых шагов
  - `error` — ошибка на конкретном шаге
- **FR-005c**: Система MUST позволять остановить активную генерацию
  через POST /api/tracks/{id}/cancel. При отмене:
  - Статус трека переходит в "cancelling", затем "cancelled"
  - ML-сервис проверяет статус трека между шагами и прерывает pipeline
  - Все завершённые шаги сохраняются в БД
  - SSE отправляет событие `cancelled` с перечислением завершённых шагов
- **FR-006**: Система MUST формировать `PersonalizedTrack`,
  включающий компетенции, матрицу ЗУН, учебные единицы,
  иерархию уровней (Базовый → Средний → Продвинутый →
  Интеграционный), lesson blueprints и понедельное расписание.
- **FR-006a**: При ошибках LLM API (сетевые сбои, rate limits,
  timeouts) система MUST выполнять до 3 повторных попыток с
  exponential backoff (1s, 2s, 4s). После исчерпания попыток
  генерация прерывается с отображением детального отчёта об
  ошибке: номер шага pipeline (B1-B8), тип ошибки, количество
  попыток, рекомендация для пользователя.
- **FR-006b**: Система MUST использовать DeepSeek API в
  OpenAI-compatible формате для всех LLM вызовов в pipeline
  B1-B8. API клиент MUST поддерживать конфигурацию через
  переменные окружения (API key, base URL, model name) для
  упрощения тестирования и потенциальной смены провайдера.

**Batch-генерация через треки:**

- **FR-006c**: Система MUST позволять запускать batch-генерацию
  N треков (2-5) из одного профиля через POST /api/tracks/generate-batch.
  Endpoint создаёт N треков с общим `batch_id` (UUID) и `batch_index` (0..N-1),
  запускает фоновую задачу для ML batch pipeline и возвращает HTTP 202
  с `{batch_id, track_ids: [...]}`.
- **FR-006d**: Система MUST предоставлять SSE endpoint
  GET /api/tracks/batch/{batch_id}/progress для отслеживания прогресса
  batch-генерации. SSE-события группируются по шагам — для каждого шага
  B1-B8 показывается прогресс всех N треков.

**Просмотр результатов:**

- **FR-007**: Система MUST отображать результат генерации в виде
  древовидной структуры с возможностью раскрытия каждого уровня
  (компетенции → ЗУН → учебные единицы → темы → расписание).
- **FR-008**: Система MUST отображать детализацию по каждой
  компетенции: связанные Знания, Умения, Навыки, учебные
  единицы, длительность.
- **FR-009**: Система MUST отображать метаданные генерации: версию
  алгоритма, timestamp, входные параметры из профиля.
- **FR-010**: Система MUST отображать индикаторы использованных
  и неиспользованных полей профиля при генерации.

**Экспорт:**

- **FR-011**: Система MUST позволять экспортировать результат
  генерации (`PersonalizedTrack`) в формате JSON.
- **FR-012**: Экспортируемый файл MUST содержать полную структуру
  трека и метаданные генерации. Именование:
  `track_[topic]_[timestamp].json`.
- **FR-013**: Система MUST позволять экспортировать QA-отчёт
  пакетной генерации в формате JSON.

**Контроль качества:**

- **FR-014**: Система MUST позволять запускать пакетную генерацию:
  от 1 до 100 версий трека из одного входного JSON.
- **FR-015**: Система MUST сравнивать версии на уровне тем:
  добавленные/удалённые темы, изменение порядка, изменение
  названий.
- **FR-016**: Система MUST выполнять углублённое сравнение:
  различия в подтемах, учебных действиях, длительности и
  приоритетах.
- **FR-017**: Система MUST рассчитывать коэффициент различия
  версий (CDV) по формуле с весами: структура тем (0.4),
  содержание подтем (0.3), состав учебных действий (0.3).
- **FR-018**: Система MUST формировать отчёт контроля качества:
  сводная таблица CDV по парам, частота тем по версиям, топ-5
  стабильных и нестабильных тем, средний CDV, стандартное
  отклонение CDV, итоговая рекомендация.

**Хранение данных:**

- **FR-019**: Система MUST сохранять загруженные профили
  (`StudentProfile`) в базу данных между сессиями.
- **FR-020**: Система MUST сохранять финальные сгенерированные
  треки (`PersonalizedTrack`) в базу данных между сессиями.
- **FR-021**: Система MUST сохранять ВСЕ промежуточные результаты
  шагов B1-B8 в базу данных (audit log) для каждой генерации
  трека. Каждая запись audit log MUST содержать: step_name
  (B1-B8), step_input (JSON), step_output (JSON), timestamp,
  track_id (связь с PersonalizedTrack), execution_time_ms.
- **FR-022**: Audit log записи MUST сохраняться с версионированием:
  при повторной генерации для того же профиля старые промежуточные
  результаты сохраняются с возможностью сравнения версий между
  разными запусками генерации.
- **FR-023**: Система MUST автоматически удалять записи
  `PipelineAuditLog` старше 30 дней для предотвращения
  неконтролируемого роста базы данных. Cleanup job выполняется
  ежедневно. Финальные треки (`PersonalizedTrack`) не удаляются
  автоматически.

### Non-Functional Requirements

**Performance:**

- **NFR-001**: Генерация одного `PersonalizedTrack` (полный pipeline
  B1-B8) MUST завершаться за 2-5 минут, не считая время вызовов
  LLM API. Это включает валидацию, обработку данных, сохранение
  audit logs и формирование результата.
- **NFR-002**: Валидация загруженного JSON профиля MUST завершаться
  за < 2 секунд для файлов размером до 100KB.
- **NFR-003**: Пакетная генерация N треков MAY выполняться
  последовательно (N × 2-5 минут + N × LLM время). Параллелизация
  вне скоупа MVP.

**Reliability:**

- **NFR-004**: Система MUST корректно обрабатывать временные сбои
  LLM API через retry mechanism (см. FR-006a) с успешностью 95%+
  при нормальной работе провайдера.

**Observability:**

- **NFR-005**: Для каждой генерации трека система MUST логировать
  все промежуточные шаги B1-B8 в audit log (см. FR-021) для
  возможности отладки и анализа ошибок.

**Data Retention:**

- **NFR-006**: Audit log записи (`PipelineAuditLog`) хранятся 30 дней,
  после чего автоматически удаляются (см. FR-023). Финальные треки
  (`PersonalizedTrack`) и профили (`StudentProfile`) хранятся
  бессрочно. Ожидаемый storage footprint: ~3GB для 30 дней audit
  logs при 100 генерациях/день.

### Key Entities

- **StudentProfile**: Профиль учащегося, загруженный из JSON.
  Содержит все поля согласно спецификации Фазы A: тема, роль,
  уровень опыта, целевые задачи, барьеры, предпочтения, расписание,
  критерии успеха. Является входом для генерации. Сохраняется в БД.
- **PersonalizedTrack**: Результат одной генерации полным pipeline
  B1-B8. Содержит компетенции, матрицу ЗУН, учебные единицы,
  иерархию уровней, lesson blueprints, понедельное расписание,
  результаты валидации B8, метаданные генерации. Связан с одним
  `StudentProfile`. Сохраняется в БД.
- **QAReport**: Отчёт контроля качества по результатам пакетной
  генерации. Содержит CDV-метрики между парами версий, частоту
  тем, топ стабильных/нестабильных тем, итоговые индикаторы,
  рекомендацию. Связан с набором `PersonalizedTrack` из одного
  `StudentProfile`.
- **PipelineAuditLog**: Audit log запись промежуточного шага
  B1-B8. Содержит: step_name (B1_validate, B2_competencies, etc.),
  step_input (JSON), step_output (JSON), timestamp,
  track_id (foreign key к PersonalizedTrack), execution_time_ms,
  version (для версионирования при повторных генерациях).
  Позволяет полную трассировку и отладку каждого шага генерации
  трека.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Разработчик может загрузить JSON, запустить генерацию
  и увидеть полный результат (компетенции, ЗУН, расписание)
  за 2-5 минут (не считая время работы LLM API). Измеряется от
  нажатия «Сгенерировать трек» до отображения финального
  `PersonalizedTrack`.
- **SC-002**: При загрузке невалидного JSON система отображает все
  ошибки валидации за одну попытку (не по одной).
- **SC-003**: Пакетная генерация 10 версий завершается и отображает
  полный QA-отчёт с CDV-метриками.
- **SC-004**: Итоговая рекомендация корректно классифицирует
  стабильность: «стабильный» при CDV < 15%, «требует доработки»
  при CDV > 30%.
- **SC-005**: Экспортированный JSON-файл содержит полную структуру
  `PersonalizedTrack` и может быть повторно загружен для анализа.
- **SC-006**: Дерево курса отображает полную иерархию: компетенции →
  ЗУН → учебные единицы → темы → подтемы → учебные действия
  с длительностью на каждом уровне.
- **SC-007**: Загруженные профили и сгенерированные треки доступны
  после перезапуска сервиса (персистентность в БД).
- **SC-008**: Для каждой генерации трека в БД сохраняются все
  8 промежуточных результатов (B1-B8) с полными входами/выходами,
  доступные для просмотра и анализа ошибок.

## Assumptions

- Это внутренний сервис для команды разработки, а не для конечных
  пользователей. Приоритет — функциональность и прозрачность
  результатов, а не визуальная полировка UI.
- Одновременно сервисом пользуется один разработчик (не требуется
  мультитенантность).
- JSON-файл с профилем готовится вручную или является выходом
  отдельного процесса Фазы A (вне скоупа данного сервиса).
- Спецификации алгоритмов в `docs/phase_a.md` (формат профиля)
  и `docs/phase_b.md` (алгоритм генерации) являются источником
  истины.
- LLM API используется DeepSeek (OpenAI-compatible format) с
  достаточными лимитами для пакетной генерации (до 100 запусков ×
  20-60 вызовов на трек). Cost: ~$0.27 за 1M токенов, что делает
  пакетную генерацию экономически эффективной.
- Сервис тестирует только Фазу B (генерацию трека). Фаза A
  (интерактивный сбор данных) и Фаза C (проведение уроков)
  вне скоупа.
- Промежуточные результаты шагов B1-B8 сохраняются в БД (audit log)
  для полной трассировки и отладки алгоритма. Storage cost
  приемлем для MVP (< 1MB на трек × до 1000 треков = ~1GB).